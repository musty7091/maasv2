{% extends 'core/base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Yoklama EkranÄ±</h4>
    
    <form method="GET" class="d-flex align-items-center">
        <label class="me-2 fw-bold">Tarih:</label>
        <input type="date" name="tarih" class="form-control" 
               value="{{ secilen_tarih|date:'Y-m-d' }}" 
               onchange="this.form.submit()">
    </form>
</div>

<div class="alert alert-info py-2 shadow-sm">
    ðŸ“… Åžu an <strong>{{ secilen_tarih }}</strong> tarihini dÃ¼zenliyorsunuz.
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-dark text-white d-none d-md-flex">
        <div class="col-3 fw-bold">Personel</div>
        <div class="col-2 fw-bold">Durum</div>
        <div class="col-2 text-center fw-bold">GiriÅŸ</div>
        <div class="col-2 text-center fw-bold">Ã‡Ä±kÄ±ÅŸ</div>
        <div class="col-3 text-center fw-bold">Ä°ÅŸlem / Bilgi</div>
    </div>
    
    <div class="list-group list-group-flush">
        {% for item in list_data %}
        <div class="list-group-item py-2">
            <form method="POST" class="row align-items-center g-2">
                {% csrf_token %}
                <input type="hidden" name="personel_id" value="{{ item.personel.id }}">
                <input type="hidden" name="kayit_tarihi" value="{{ secilen_tarih|date:'Y-m-d' }}">
                
                <div class="col-md-3 col-12">
                    <span class="fw-bold text-primary">{{ item.personel.ad }} {{ item.personel.soyad }}</span>
                </div>

                <div class="col-md-2 col-6">
                    <select name="durum" class="form-select form-select-sm" onchange="toggleSaatler(this)">
                        <option value="" {% if not item.kayit %}selected{% endif %}>-- SeÃ§iniz --</option>
                        <option value="geldi" {% if item.kayit.durum == 'geldi' %}selected{% endif %}>Geldi</option>
                        <option value="hafta_tatili" {% if item.kayit.durum == 'hafta_tatili' %}selected{% endif %}>Hafta Tatili</option>
                        <option value="gelmedi" {% if item.kayit.durum == 'gelmedi' %}selected{% endif %}>Gelmedi</option>
                        <option value="izinli" {% if item.kayit.durum == 'izinli' %}selected{% endif %}>Ä°zinli</option>
                        <option value="ucretsiz_izin" {% if item.kayit.durum == 'ucretsiz_izin' %}selected{% endif %}>Ãœcretsiz Ä°zin</option>
                        <option value="raporlu" {% if item.kayit.durum == 'raporlu' %}selected{% endif %}>Raporlu</option>
                    </select>
                </div>

                <div class="col-md-2 col-3">
                    <input type="time" name="giris_saati"
                            class="form-control form-control-sm text-center saat-input"
                            value="{% if item.kayit and item.kayit.giris_saati %}{{ item.kayit.giris_saati|date:'H:i' }}{% endif %}">

                </div>

                <div class="col-md-2 col-3">
                    <input type="time" name="cikis_saati"
                            class="form-control form-control-sm text-center saat-input"
                            value="{% if item.kayit and item.kayit.cikis_saati %}{{ item.kayit.cikis_saati|date:'H:i' }}{% endif %}">
                </div>

                <div class="col-md-3 col-12 d-flex align-items-center justify-content-between">
                    <button type="submit" class="btn btn-primary btn-sm px-3 me-2">ðŸ’¾ Kaydet</button>
                    
                    {% if item.kayit %}
                        <span class="badge rounded-pill
                            {% if item.kayit.hesaplanan_mesai_saati > 0 %} bg-success 
                            {% elif item.kayit.hesaplanan_mesai_saati < 0 %} bg-danger 
                            {% else %} bg-secondary {% endif %}">
                            
                            {% if item.kayit.hesaplanan_mesai_saati > 0 %}
                                +{{ item.kayit.hesaplanan_mesai_saati }} Saat
                            {% elif item.kayit.hesaplanan_mesai_saati < 0 %}
                                {{ item.kayit.hesaplanan_mesai_saati }} Eksik
                            {% else %}
                                Tamam
                            {% endif %}
                        </span>
                    {% else %}
                        <span class="badge bg-light text-muted border">Bekliyor</span>
                    {% endif %}
                </div>
            </form>
        </div>
        {% endfor %}
    </div>
</div>

<div style="height: 50px;"></div>

<script>
    // 1. KUTU KÄ°LÄ°TLEME
    function toggleSaatler(selectElement) {
        const form = selectElement.closest('form');
        const inputs = form.querySelectorAll('.saat-input');
        
        const aktif = (selectElement.value === 'geldi' || selectElement.value === 'hafta_tatili');

        inputs.forEach(input => {
            input.disabled = !aktif;
            input.style.backgroundColor = !aktif ? '#e9ecef' : '#fff';
            input.style.color = !aktif ? '#6c757d' : '#000';
        });
    }

    // 2. OTOMATÄ°K ':' KOYUCU
    function formatTimeInput(e) {
        let input = e.target;
        let value = input.value.replace(/\D/g, ''); 
        
        if (value.length > 4) value = value.slice(0, 4);

        if (value.length > 2) {
            input.value = value.slice(0, 2) + ':' + value.slice(2);
        } else {
            input.value = value;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const selects = document.querySelectorAll('select[name="durum"]');
        selects.forEach(select => {
            toggleSaatler(select);
        });

        const saatInputs = document.querySelectorAll('.saat-input');
        saatInputs.forEach(input => {
            input.addEventListener('input', formatTimeInput);
        });
    });
</script>
{% endblock %}